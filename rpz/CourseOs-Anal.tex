\newpage
\section{Аналитическая часть}\label{sec:anal}

\subsection{Постановка задачи}\label{ssec:problem}

В соответствии с заданием на курсовую работу, необходимо разработать драйвер для платы Raspberry Pi 3 под управлением операционной системы Raspbian.

Для реализации поставленной задачи необходимо:
\begin{itemize}
\item исследовать особенности передачи информации плате Raspberry Pi 3;
\item исследовать возможность подключения к плате Raspberry Pi 3 контроллера PCD8544;
\item разработать драйвер для платы Raspberry Pi под управлением операционной системы Raspbian;
\item разработать консольное приложение, выполняющееся на компьютере под управлением операционной системы Windows 10.
\end{itemize}

\subsection{Вычислительная платформа}\label{ssec:platform}
В качестве вычислительной платформы используется наиболее популярный миникомпьютер Raspberry Pi 3 B+. Это однокристальная система, включающая 64-битный ARMv8 процессор Cortex-A53 и 1 гигабайт LPDDR2 памяти \cite{rpi3b+}. Для подключения внешних устройств в системе присутствует 40-пиновый GPIO (интерфейс ввода/вывода общего назначения) (Рисунок \ref{ris:pinout_gpio}) с функциями PWM, SPI, I2C и UART.

\begin{figure}[H]
\center
\includegraphics[width=0.6\textwidth]{pinout_gpio.png}
\caption{Распиновка GPIO}
\label{ris:pinout_gpio}
\end{figure}

\subsection{Контроллер PCD8544}\label{ssec:controller}
PCD8544 - контроллер, управляющий жидкокристаллическим экраном с разрешением 48х84 пикселей на одной микросхеме.
Все необходимые функции для экрана реализованы в контроллере, они включают:
\begin{itemize}
\item генерация и подача питания для ЖК-экрана;
\item осциллятор для системы контроллер-экран;
\item память для отображаемой информации.
\end{itemize}

Взаимодействие с контроллером проводится через последовательный интерфейс передачи данных (SPI) по следующим каналам \cite{datasheet_pcd8544} (Рисунок \ref{ris:pcd8544_pinout}):
\begin{itemize}
\item SDIN (последовательный канал входных данных);
\item SCLK (вход тактового сигнала);
\item D/C (входной сигнал режима данные/команда);
\item SCE (вход выбора микросхемы);
\item RES (входной сигнал сброса состояния микросхемы).
\end{itemize}

\begin{figure}[H]
\center
\includegraphics[width=0.5\textwidth]{pcd8544_pinout.png}
\caption{Распиновка PCD8544}
\label{ris:pcd8544_pinout}
\end{figure}

\subsection{Протокол взаимодействия SPI}\label{ssec:spi_proto}
Последовательный периферийный интерфейс (SPI) - это спецификация синхронного последовательного интерфейса взаимодействия, используемая для связи на коротких расстояниях, в основном во встроенных системах.

Устройства SPI взаимодействуют в полнодуплексном режиме с использованием архитектуры master - slave с одним ведущим устройством. Только ведущий может порождать импульсы синхронизации. Выбор ведомого устройства для обмена информации поддерживается посредством отдельных линий slave select (SS), иногда называемых ship select (CS) \cite{spi_interface}.

Шина SPI определяет четыре логических сигнала (Рисунок \ref{ris:spi_ms}):

\begin{itemize}
\item SCLK: Serial Clock, тактовый сигнал, исходит от ведущего устройства;
\item MOSI: Master Output Slave Input, вывод данных из ведущего устройства;
\item MISO: Master Input Slave Output, вывод данных из ведомого устройства;
\item SS: Slave Select, выбор ведомой микросхемы.
\end{itemize}

\begin{figure}[H]
\center
\includegraphics[width=0.7\textwidth]{spi_ms.png}
\caption{Подключение SPI устройств}
\label{ris:spi_ms}
\end{figure}

Существует четыре режима работы SPI устройств (Рисунок \ref{ris:spi_mode}), которые представляют собой комбинацию двух бит:
\begin{enumerate}
\item {
	CPOL (Clock Polarity) — определяет начальный уровень (полярность) сигнала синхронизации.
	\begin{itemize}
	\item CPOL=0 показывает, что сигнал синхронизации начинается с низкого уровня, так что передний фронт является нарастающим, а задний — падающим;
	\item CPOL=1, сигнал синхронизации начинается с высокого уровня, таким образом передний фронт является падающим, а задний — нарастающим.
	\end{itemize}
}
\item {
	CPHA (Clock Phase) — фаза синхронизации, определяет по какому из фронтов синхронизирующего сигнала производить выборку данных.
	\begin{itemize}
	\item CPHA=0 показывает что необходимо производить выборку по переднему фронту;
	\item CPHA=1 показывает что выборку данных необходимо производить по заднему фронту.
	\end{itemize}
}
\end{enumerate}

\begin{figure}[H]
\center
\includegraphics[width=0.7\textwidth]{spi_mode.png}
\caption{Временная диаграмма полярности и фазы тактового сигнала}
\label{ris:spi_mode}
\end{figure}

\subsection{Взаимодйствие с контроллером через последовательный интерфейс}
Перед началом работы с контроллером необходимо перевести бит SCE в логическую единицу, а затем последовательно установить бит RES сначала в логическую единицу, а затем в логический нуль. Это проинициализирует контроллер и сбросит все внутренние регистры \cite{datasheet_pcd8544}.

Когда бит SCE переходит в логический нуль, последовательный интерфейс начинает работу и производится передача информации. В байте первым передается старший значащий бит. Чтение бита происходит на положительном фронте тактового сигнала (Рисунок \ref{ris:pcd8544_diagram}).

Формат инструкций разделен на два режима:
\begin{itemize}
\item команда (если D/C – логический нуль);
\item данные (если D/C – логическая единица).
\end{itemize}

\begin{figure}[H]
\center
\includegraphics[width=\textwidth]{pcd8544_diagram.png}
\caption{Передача нескольких байт по 	протоколу последовательной шины}
\label{ris:pcd8544_diagram}
\end{figure}

Вывод сигналов происходит на предопределенные выводы GPIO.

\subsection{Реализация драйверов устройств в Unix}
Драйвер – программа или часть кода ядра, предназначенная для управления конкретным устройством. Обычно драйверы устройств содержат последовательность команд, специфичных для конкретного устройства \cite{razanova}.

Драйверы в Unix бывают трех типов:
\begin{enumerate}
\item Встроенные в ядро - соответствующие устройства автоматически обнаруживаются системой и становятся доступными системе\\ примеры: последовательные и параллельные порты, мат плата.
\item Драйверы - загружаемые модули ядра. Загружаемые модули часто используются для управления такими устройствами, как SCSI-устройствами, звуковыми и сетевыми картами. Для подключения отключения в работающей системе имеются специальные утилиты.
\item Код драйверов третьего типа поделён между ядром и специальной утилитой. Например, у драйвера принтера ядро отвечает за взаимодействие с параллельным портом, а формирование управляющих сигналов для принтера осуществляется демоном печати lpd, который для этого использует специальную программу-фильтр.
\end{enumerate}

В системе имеется два типа специальный файлов устройств:
\begin{itemize}
\item символьный;
\item блочный.
\end{itemize}

Единственным блочным устройством является HDD, все остальное - символьные, следовательно в данной работе реализуется драйвер символьного устройства.
